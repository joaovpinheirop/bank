<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leil√£o de Natal üéÑ</title>
</head>
<body>

<div class="container">

    
      <h1>JPBANK</h1>

    <input type="text" id="nomeBusca" placeholder="Digite seu nome (Ex: Joao)">
  

    <div id="resultado" style="display: none;">
        <div class="status-box">
            <div id="resNome" style="font-weight: bold; text-transform: uppercase;"></div>
            <div class="saldo-gigante">R$ <span id="resSaldo">0</span></div>
            <p>Itens: <span id="resCompras" class="lista-compras">---</span></p>
        </div>
    </div>

    <div id="admin" class="admin-panel">
        <h3>Registrar Venda</h3>
        <input type="number" id="lanceValor" placeholder="Valor do Lance (R$)">
        <input type="text" id="lanceItem" placeholder="Nome do Item (Ex: Panetone)">
        <button class="btn-admin" onclick="registrarVenda()">CONFIRMAR VENDA</button>
    </div>
</div>

<script>
    // Fun√ß√£o executada assim que a p√°gina abre
    window.onload = () => {
        const caminho = window.location.pathname; // Pega "/bank/Joao"
        const partes = caminho.split('/');
        const nomeDaUrl = partes[partes.length - 1]; // Pega apenas "Joao"

        if (nomeDaUrl && nomeDaUrl !== 'index.html') {
            document.getElementById('nomeBusca').value = decodeURIComponent(nomeDaUrl);
            
            // Inicia a busca imediata
            buscarDados();

            // Configura para atualizar AUTOMATICAMENTE a cada 2 segundos
            console.log("Monitorando saldo para: " + nomeDaUrl);
            setInterval(() => {
                buscarDados(true); // Passamos true para evitar alertas de erro na tela
            }, 2000);
        }
    };

    async function buscarDados(silencioso = false) {
        const nomeInput = document.getElementById('nomeBusca').value.trim();
        if (!nomeInput) return;

        try {
            const response = await fetch('/api/jogadores');
            const jogadores = await response.json();
            
            const j = jogadores.find(item => item.nome.toLowerCase() === nomeInput.toLowerCase());

            if (j) {
                // Atualiza os campos na tela
                document.getElementById('resNome').innerText = j.nome;
                document.getElementById('resSaldo').innerText = j.saldo.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                document.getElementById('resCompras').innerText = j.compras.length > 0 ? j.compras.join(', ') : "Nenhum item";
                
                document.getElementById('resultado').style.display = 'block';
            } else if (!silencioso) {
                alert("Jogador n√£o encontrado!");
            }
        } catch (e) {
            if (!silencioso) console.error("Erro ao conectar com o servidor.");
        }
    }

    // Fun√ß√£o para o Admin (se necess√°rio nesta p√°gina)
    async function registrarVenda() {
        const nome = document.getElementById('nomeBusca').value.trim();
        const valor = parseFloat(document.getElementById('lanceValor').value);
        const item = document.getElementById('lanceItem').value;

        if (!nome || !valor || !item) return alert("Preencha tudo!");

        const response = await fetch('/api/lance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nome, valor, item })
        });

        const data = await response.json();
        if (data.sucesso) {
            buscarDados(true);
        } else {
            alert(data.erro);
        }
    }
</script>

</body>
</html>